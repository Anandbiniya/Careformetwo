!function(){"use strict";frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.DataTableManager=class{constructor(e){Object.assign(this,e),this.dialog_manager=new erpnext.accounts.bank_reconciliation.DialogManager(this.company,this.bank_account,this.bank_statement_from_date,this.bank_statement_to_date,this.filter_by_reference_date,this.from_reference_date,this.to_reference_date),this.make_dt()}make_dt(){var e=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_bank_transactions",args:{bank_account:this.bank_account,from_date:this.bank_statement_from_date,to_date:this.bank_statement_to_date},callback:function(t){e.format_data(t.message),e.get_dt_columns(),e.get_datatable(),e.set_listeners()}})}get_dt_columns(){var e=this;this.columns=[{name:__("Date"),editable:!1,width:100},{name:__("Party Type"),editable:!1,width:95},{name:__("Party"),editable:!1,width:100},{name:__("Description"),editable:!1,width:350},{name:__("Deposit"),editable:!1,width:100,format:function(t){return"<span style='color:green;'>"+format_currency(t,e.currency)+"</span>"}},{name:__("Withdrawal"),editable:!1,width:100,format:function(t){return"<span style='color:red;'>"+format_currency(t,e.currency)+"</span>"}},{name:__("Unallocated Amount"),editable:!1,width:100,format:function(t){return"<span style='color:var(--blue-500);'>"+format_currency(t,e.currency)+"</span>"}},{name:__("Reference Number"),editable:!1,width:140},{name:__("Actions"),editable:!1,sortable:!1,focusable:!1,dropdown:!1,width:100}]}format_data(e){var t,a=this;this.transactions=[],e[0]&&(this.currency=e[0].currency),this.transaction_dt_map={},e.forEach(function(e){t=a.transactions.push(a.format_row(e)),a.transaction_dt_map[e.name]=t-1})}format_row(e){return[e.date,e.party_type,e.party,e.description,e.deposit,e.withdrawal,e.unallocated_amount,e.reference_number,'\n\t\t\t<Button class="btn btn-primary btn-xs center"  data-name = '+e.name+" >\n\t\t\t\t"+__("Actions")+"\n\t\t\t</a>\n\t\t\t"]}get_datatable(){var e={columns:this.columns,data:this.transactions,dynamicRowHeight:!0,checkboxColumn:!1,inlineFilters:!0};this.datatable=new frappe.DataTable(this.$reconciliation_tool_dt.get(0),e),$("."+this.datatable.style.scopeClass+" .dt-scrollable").css("max-height","calc(100vh - 400px)"),this.transactions.length>0?(this.$reconciliation_tool_dt.show(),this.$no_bank_transactions.hide()):(this.$reconciliation_tool_dt.hide(),this.$no_bank_transactions.show())}set_listeners(){var e=this;$("."+this.datatable.style.scopeClass+" .dt-scrollable").on("click",".btn",function(){return e.dialog_manager.show_dialog($(this).attr("data-name"),function(t){return e.update_dt_cards(t)}),!0})}update_dt_cards(e){var t=this,a=this.transaction_dt_map[e.name];if(e.unallocated_amount>0)this.transactions[a]=this.format_row(e);else{this.transactions.splice(a,1);for(var n=0,r=Object.entries(this.transaction_dt_map);n<r.length;n+=1){var o=r[n],c=o[0],i=o[1];i>a&&(this.transaction_dt_map[c]=i-1)}}this.datatable.refresh(this.transactions,this.columns),0==this.transactions.length&&(this.$reconciliation_tool_dt.hide(),this.$no_bank_transactions.show()),this.get_cleared_balance().then(function(){t.cards_manager.$cards[1].set_value(format_currency(t.cleared_balance),t.currency),t.cards_manager.$cards[2].set_value(format_currency(t.bank_statement_closing_balance-t.cleared_balance),t.currency),t.cards_manager.$cards[2].set_value_color(t.bank_statement_closing_balance-t.cleared_balance==0?"text-success":"text-danger")})}get_cleared_balance(){var e=this;if(this.bank_account&&this.bank_statement_to_date)return frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_account_balance",args:{bank_account:this.bank_account,till_date:this.bank_statement_to_date},callback:function(t){return e.cleared_balance=t.message}})}},frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.NumberCardManager=class{constructor(e){Object.assign(this,e),this.make_cards()}make_cards(){var e=this;this.$reconciliation_tool_cards.empty(),this.$cards=[],this.$summary=$('<div class="report-summary"></div>').hide().appendTo(this.$reconciliation_tool_cards),[{value:this.bank_statement_closing_balance,label:__("Closing Balance as per Bank Statement"),datatype:"Currency",currency:this.currency},{value:this.cleared_balance,label:__("Closing Balance as per ERP"),datatype:"Currency",currency:this.currency},{value:this.bank_statement_closing_balance-this.cleared_balance,label:__("Difference"),datatype:"Currency",currency:this.currency}].forEach(function(t){var a=new erpnext.accounts.NumberCard(t);e.$cards.push(a),a.$card.appendTo(e.$summary)}),this.$cards[2].set_value_color(this.bank_statement_closing_balance-this.cleared_balance==0?"text-success":"text-danger"),this.$summary.css({"border-bottom":"0px","margin-left":"0px","margin-right":"0px"}),this.$summary.show()}},erpnext.accounts.NumberCard=class{constructor(e){this.$card=frappe.utils.build_summary_item(e)}set_value(e){this.$card.find("div").text(e)}set_value_color(e){this.$card.find("div").removeClass("text-danger text-success").addClass(""+e)}set_indicator(e){this.$card.find("span").removeClass("indicator red green").addClass("indicator "+e)}},frappe.provide("erpnext.accounts.bank_reconciliation"),erpnext.accounts.bank_reconciliation.DialogManager=class{constructor(e,t,a,n,r,o,c){this.bank_account=t,this.company=e,this.make_dialog(),this.bank_statement_from_date=a,this.bank_statement_to_date=n,this.filter_by_reference_date=r,this.from_reference_date=o,this.to_reference_date=c}show_dialog(e,t){var a=this;this.bank_transaction_name=e,this.update_dt_cards=t,frappe.call({method:"frappe.client.get_value",args:{doctype:"Bank Transaction",filters:{name:this.bank_transaction_name},fieldname:["date","deposit","withdrawal","currency","description","name","bank_account","company","reference_number","party_type","party","unallocated_amount","allocated_amount","transaction_type"]},callback:function(e){e.message&&(a.bank_transaction=e.message,e.message.payment_entry=1,e.message.journal_entry=1,a.dialog.set_values(e.message),a.copy_data_to_voucher(),a.dialog.show())}})}copy_data_to_voucher(){var e={reference_number:this.bank_transaction.reference_number||this.bank_transaction.description,posting_date:this.bank_transaction.date,reference_date:this.bank_transaction.date,mode_of_payment:this.bank_transaction.transaction_type};this.dialog.set_values(e)}get_linked_vouchers(e){var t=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.get_linked_payments",args:{bank_transaction_name:this.bank_transaction_name,document_types:e,from_date:this.bank_statement_from_date,to_date:this.bank_statement_to_date,filter_by_reference_date:this.filter_by_reference_date,from_reference_date:this.from_reference_date,to_reference_date:this.to_reference_date},callback:function(e){var a=e.message;if(a&&a.length>0){var n=t.dialog.fields_dict.payment_proposals.$wrapper;n.show(),t.dialog.fields_dict.no_matching_vouchers.$wrapper.hide(),t.data=[],a.forEach(function(e){var a=e[5]?e[5]:e[8];t.data.push([e[1],e[2],a,format_currency(e[3],e[9]),e[4],e[6]])}),t.get_dt_columns(),t.get_datatable(n)}else{t.dialog.fields_dict.payment_proposals.$wrapper.hide(),t.dialog.fields_dict.no_matching_vouchers.$wrapper.show()}t.dialog.show()}})}get_dt_columns(){this.columns=[{name:__("Document Type"),editable:!1,width:125},{name:__("Document Name"),editable:!1,width:1},{name:__("Reference Date"),editable:!1,width:120},{name:__("Remaining"),editable:!1,width:100},{name:__("Reference Number"),editable:!1,width:200},{name:__("Party"),editable:!1,width:100}]}get_datatable(e){if(this.datatable)this.datatable.refresh(this.data,this.columns),this.datatable.rowmanager.checkMap=[];else{var t={columns:this.columns,data:this.data,dynamicRowHeight:!0,checkboxColumn:!0,inlineFilters:!0};this.datatable=new frappe.DataTable(e.get(0),t)}}make_dialog(){var e=this,t=this;t.selected_payment=null;var a=[{label:__("Action"),fieldname:"action",fieldtype:"Select",options:"Match Against Voucher\nCreate Voucher\nUpdate Bank Transaction",default:"Match Against Voucher"},{fieldname:"column_break_4",fieldtype:"Column Break"},{label:__("Document Type"),fieldname:"document_type",fieldtype:"Select",options:"Payment Entry\nJournal Entry",default:"Payment Entry",depends_on:"eval:doc.action=='Create Voucher'"},{fieldtype:"Section Break",fieldname:"section_break_1",label:__("Filters"),depends_on:"eval:doc.action=='Match Against Voucher'"}];frappe.call({method:"erpnext.accounts.doctype.bank_transaction.bank_transaction.get_doctypes_for_bank_reconciliation",callback:function(n){$.each(n.message,function(t,n){t%3==0&&a.push({fieldtype:"Column Break"}),a.push({fieldtype:"Check",label:n,fieldname:frappe.scrub(n),onchange:function(){return e.update_options()}})}),a.push.apply(a,e.get_voucher_fields()),t.dialog=new frappe.ui.Dialog({title:__("Reconcile the Bank Transaction"),fields:a,size:"large",primary_action:function(t){return e.reconciliation_dialog_primary_action(t)}})}})}get_voucher_fields(){var e=this;return[{fieldtype:"Check",label:"Show Only Exact Amount",fieldname:"exact_match",onchange:function(){return e.update_options()}},{fieldname:"column_break_5",fieldtype:"Column Break"},{fieldtype:"Check",label:"Bank Transaction",fieldname:"bank_transaction",onchange:function(){return e.update_options()}},{fieldtype:"Section Break",fieldname:"section_break_1",label:__("Select Vouchers to Match"),depends_on:"eval:doc.action=='Match Against Voucher'"},{fieldtype:"HTML",fieldname:"payment_proposals"},{fieldtype:"HTML",fieldname:"no_matching_vouchers",options:__('<div class="text-muted text-center">{0}</div>',[__("No Matching Vouchers Found")])},{fieldtype:"Section Break",fieldname:"details",label:"Details",depends_on:"eval:doc.action!='Match Against Voucher'"},{fieldname:"reference_number",fieldtype:"Data",label:"Reference Number",mandatory_depends_on:"eval:doc.action=='Create Voucher'"},{default:"Today",fieldname:"posting_date",fieldtype:"Date",label:"Posting Date",reqd:1,depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"reference_date",fieldtype:"Date",label:"Cheque/Reference Date",mandatory_depends_on:"eval:doc.action=='Create Voucher'",depends_on:"eval:doc.action=='Create Voucher'",reqd:1},{fieldname:"mode_of_payment",fieldtype:"Link",label:"Mode of Payment",options:"Mode of Payment",depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"edit_in_full_page",fieldtype:"Button",label:"Edit in Full Page",click:function(){e.edit_in_full_page()},depends_on:"eval:doc.action=='Create Voucher'"},{fieldname:"column_break_7",fieldtype:"Column Break"},{default:"Bank Entry",fieldname:"journal_entry_type",fieldtype:"Select",label:"Journal Entry Type",options:"Journal Entry\nInter Company Journal Entry\nBank Entry\nCash Entry\nCredit Card Entry\nDebit Note\nCredit Note\nContra Entry\nExcise Entry\nWrite Off Entry\nOpening Entry\nDepreciation Entry\nExchange Rate Revaluation\nDeferred Revenue\nDeferred Expense",depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'"},{fieldname:"second_account",fieldtype:"Link",label:"Account",options:"Account",depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Journal Entry'",get_query:function(){return{filters:{is_group:0,company:e.company}}}},{fieldname:"party_type",fieldtype:"Link",label:"Party Type",options:"DocType",mandatory_depends_on:"eval:doc.action=='Create Voucher' &&  doc.document_type=='Payment Entry'",get_query:function(){return{filters:{name:["in",Object.keys(frappe.boot.party_account_types)]}}}},{fieldname:"party",fieldtype:"Dynamic Link",label:"Party",options:"party_type",mandatory_depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldname:"project",fieldtype:"Link",label:"Project",options:"Project",depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldname:"cost_center",fieldtype:"Link",label:"Cost Center",options:"Cost Center",depends_on:"eval:doc.action=='Create Voucher' && doc.document_type=='Payment Entry'"},{fieldtype:"Section Break",fieldname:"details_section",label:"Transaction Details"},{fieldname:"date",fieldtype:"Date",label:"Date",read_only:1},{fieldname:"deposit",fieldtype:"Currency",label:"Deposit",options:"account_currency",read_only:1},{fieldname:"withdrawal",fieldtype:"Currency",label:"Withdrawal",options:"account_currency",read_only:1},{fieldname:"column_break_17",fieldtype:"Column Break",read_only:1},{fieldname:"description",fieldtype:"Small Text",label:"Description",read_only:1},{fieldname:"allocated_amount",fieldtype:"Currency",label:"Allocated Amount",options:"account_currency",read_only:1},{fieldname:"unallocated_amount",fieldtype:"Currency",label:"Unallocated Amount",options:"account_currency",read_only:1},{fieldname:"account_currency",fieldtype:"Link",label:"Currency",options:"Currency",read_only:1,hidden:1}]}get_selected_attributes(){var e=[];return this.dialog.$wrapper.find(".checkbox input").each(function(t,a){$(a).is(":checked")&&e.push($(a).attr("data-fieldname"))}),e}update_options(){var e=this.get_selected_attributes();this.get_linked_vouchers(e)}reconciliation_dialog_primary_action(e){"Match Against Voucher"==e.action&&this.match(e),"Create Voucher"==e.action&&"Payment Entry"==e.document_type&&this.add_payment_entry(e),"Create Voucher"==e.action&&"Journal Entry"==e.document_type?this.add_journal_entry(e):"Update Bank Transaction"==e.action&&this.update_transaction(e)}match(){var e=this,t=this.datatable.rowmanager.checkMap,a=[];t.forEach(function(t,n){1==t&&a.push(e.datatable.datamanager.rows[n])});var n=[];a.forEach(function(e){n.push({payment_doctype:e[2].content,payment_name:e[3].content,amount:e[5].content})}),frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.reconcile_vouchers",args:{bank_transaction_name:this.bank_transaction.name,vouchers:n},callback:function(t){var a=__("Bank Transaction {0} Matched",[e.bank_transaction.name]);frappe.show_alert(a),e.update_dt_cards(t.message),e.dialog.hide()}})}add_payment_entry(e){var t=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_payment_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,project:e.project,cost_center:e.cost_center},callback:function(e){var a=__("Bank Transaction {0} added as Payment Entry",[t.bank_transaction.name]);frappe.show_alert(a),t.update_dt_cards(e.message),t.dialog.hide()}})}add_journal_entry(e){var t=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_journal_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,entry_type:e.journal_entry_type,second_account:e.second_account},callback:function(e){var a=__("Bank Transaction {0} added as Journal Entry",[t.bank_transaction.name]);frappe.show_alert(a),t.update_dt_cards(e.message),t.dialog.hide()}})}update_transaction(e){var t=this;frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.update_bank_transaction",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,party_type:e.party_type,party:e.party},callback:function(e){var a=__("Bank Transaction {0} updated",[t.bank_transaction.name]);frappe.show_alert(a),t.update_dt_cards(e.message),t.dialog.hide()}})}edit_in_full_page(){var e=this.dialog.get_values(!0);"Payment Entry"==e.document_type?frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_payment_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,project:e.project,cost_center:e.cost_center,allow_edit:!0},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}}):frappe.call({method:"erpnext.accounts.doctype.bank_reconciliation_tool.bank_reconciliation_tool.create_journal_entry_bts",args:{bank_transaction_name:this.bank_transaction.name,reference_number:e.reference_number,reference_date:e.reference_date,party_type:e.party_type,party:e.party,posting_date:e.posting_date,mode_of_payment:e.mode_of_payment,entry_type:e.journal_entry_type,second_account:e.second_account,allow_edit:!0},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})}}}();
//# sourceMappingURL=bank-reconciliation-tool.min.js.map
